<!-- この文書は設計上の判断や構成を理解しやすくするためのコメントです。 -->
# Idle Dungeon (仮) 設計

## 全体構成
- 表示層: 右下の小さな表示、メニュー表示、クリック受付。
- 進行層: 自動移動、戦闘、イベント、会話の進行。
- 成長層: レベル、ステータス、装備、仲間、解放。
- 記録層: 進行状況と実績の保存、読み込み。
- 連携層: 入力実績の収集、Git連携の任意機能。

## ゲームループと状態遷移
- 状態は「移動中」「戦闘中」「会話中」「報酬表示」「敗北」の五つを基本にする。
- 起動直後は「移動中」から始め、常に右方向へ距離を進める。
- 敵遭遇で「戦闘中」に遷移し、勝利後は「報酬表示」から「移動中」へ戻る。
- 物語イベントは「会話中」に遷移し、時間経過で自動的に進む。
- 敗北時は「敗北」からステージ開始地点へ戻り、「移動中」へ復帰する。
<!-- この項目は無限ダンジョンの設計方針を明示するためのコメントです。 -->
- ラストダンジョンは距離が無限で、節目距離のリストからボス戦を起動する。
<!-- この項目はステージ進行の設計方針を明確にするためのコメントです。 -->
- ステージには長さを持たせ、到達時に自動で次のステージへ遷移する。

## 自動進行とタイミング
- 進行は一定周期のタイマーで更新し、描画は差分のみ行う。
- 会話は既定12秒で自動進行し、残り秒数のインジケータを表示する。
- 自動進行の周期は設定で変更できる。
<!-- この項目は自動開始の設計方針を明確にするためのコメントです。 -->
- 自動開始は既定で有効とし、保存された設定に従って起動時の開始可否を決める。

## 戦闘と成長
- 戦闘は一行のログで推移を示し、詳細な演出は省く。
- ダメージ計算は単純な式で、強さの差を分かりやすくする。
- レベルアップ時にステータスポイントを付与し、自動配分の規則を選べる。

## イベントと会話
- シナリオは一本道で、分岐や選択肢は作らない。
- 会話中も作業を妨げないように表示を控えめにする。
- 重要イベントのみ短い特別演出を付ける。

## メニューと操作
- クリックまたは `:IdleDungeonMenu` でメニューを開く。
- メニューは装備、開始ダンジョン、武器の購入と販売、キャラクター変更の項目を持つ。
- メニュー内の操作はキーボードのみで完結させる。
<!-- この項目はメニューの見た目に関する設計方針を明示するためのコメントです。 -->
- メニューは画面中央の浮動ウィンドウで開き、落ち着いた配色と最小限の装飾で見やすくする。
<!-- この項目は初期化機能の設計意図を明示するためのコメントです。 -->
- 全データ初期化は誤操作を避けるため確認画面を必ず挟む。

## 入力実績と解放
- 入力文字数、行数、保存回数、作業時間、ファイル種別別の入力を記録する。
- 実績は段階的に設定し、達成で装備や称号を解放する。
- 解放はゲーム進行に影響するが、必須ではない。

<!-- ここではコンテンツ定義の読み込み方針を示すコメントです。 -->
## コンテンツ管理
- キャラクター、装備、イベントは `docs/content.md` に定義し、起動時に読み込む。
- キャラクターは固有効果と初期装備を持ち、切り替え後も進行距離は維持する。
- イベントは距離とステージで起動し、会話が終わると自動進行に戻る。

## データ構造
```lua
state = {
  progress = { stage = 1, distance = 0, checkpoint = 0 },
  actor = { level = 1, hp = 10, max_hp = 10, stats = { atk = 1, def = 1 } },
  equipment = { weapon = nil, armor = nil, accessory = nil, companion = nil },
  currency = { gold = 0 },
  flags = { auto_allocate = false },
  metrics = { chars = 0, lines = 0, saves = 0, time_sec = 0, filetypes = {} },
  unlocks = { items = {}, titles = {} },
  ui = { mode = "move", dialogue_timer = 60 },
}
```

## 保存
- `stdpath("data")` 配下に保存し、起動時に復帰する。
- 自動保存は一定間隔で実行し、失敗時は直前のバックアップに戻せるようにする。
- 保存時は一時ファイルへ書き込み後、置き換えて破損を防ぐ。
<!-- この項目は複数起動時の設計方針を明示するためのコメントです。 -->
- 保存データはユーザー単位の単一ファイルとし、プロジェクトでは分けない。
- ロックファイルで単一インスタンスだけが更新し、他は読み取り専用として同期する。

## ユーザーインターフェース
- 右下に固定した小さな表示で、体力、距離、ゴールドを示す。
- 会話中はインジケータのみ色を変え、視線移動を最小化する。
- 画面幅が変わっても表示位置を維持する。
- 表示は1行を基本とし、必要な場合でも2行を超えないようにする。
<!-- この項目はペット表示の設計意図を補足するためのコメントです。 -->
- 可視モードはドット調のペットを1行トラックに描画し、進行とともに歩行させる。
- ペットの表情はキャラクターと仲間装備の情報に応じて切り替える。
<!-- この項目は情報表示の設計意図を補足するためのコメントです。 -->
- 2行表示のときは1行目にステージ名と進行度、2行目に体力や次のイベントなどの情報を巡回表示する。
<!-- この項目は言語設定の扱いを明確にするためのコメントです。 -->
- 表示言語は状態に保持し、メニューで英語と日本語を切り替えられる。

## Git連携によるログインとランキング(任意)
- ログインはGit設定のユーザー名と電子メールアドレスを読み取り、任意で有効化する。
- ランキングはローカルで集計し、メニューからのみ閲覧できる。
- 共有したい場合は、Gitのノートや専用ブランチに成績を記録し、任意でプッシュする方式を検討する。
- ネットワーク通信は明示的な操作がある場合のみ行い、既定では無効にする。

## テスト方針
- 進行、戦闘、会話、解放の各機能を関数単位で検証できる構成にする。
- 表示更新と保存の境界は疑似データで確認し、副作用を最小化する。
